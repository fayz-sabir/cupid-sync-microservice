# Installation and Usage Guide

This guide explains how to build and run the Cupid Sync microservice, call its REST APIs, and view metrics in Grafana.

## Prerequisites
- **Java 17** and **Maven 3.9+**
- **Docker** for running Postgres, Redis and the application via *docker-compose*
- (Optional) **Kubernetes** and `kubectl` if you want to deploy the manifests in `infra/k8s`

## Build
From the repository root run:

```bash
mvn clean package
```

This compiles all modules and executes the tests.

## Run Locally with Docker Compose
A `docker-compose.yml` file starts the application together with Postgres and Redis. Before launching the stack, build the application image from the repository root:

```bash
docker build -t cupid-sync-app:1.0.0 -f infra/docker/cupid-sync-app/Dockerfile .
```

Then start the services with:

```bash
docker-compose up --build
```

The API is then available at `http://localhost:8089`.

## REST API
The web module exposes hotel-related endpoints:

```bash
# Fetch hotel data
curl "http://localhost:8089/api/v1/hotels/123?lang=en&includeReviews=true&reviewLimit=10"

# Trigger a hotel synchronization
curl -X POST "http://localhost:8089/api/v1/hotels/123/sync?warmLang=en"

# Trigger a review synchronization
curl -X POST "http://localhost:8089/api/v1/hotels/123/reviews/sync?limit=20"

# Trigger a full force synchronization of all configured hotels
curl -X POST "http://localhost:8089/api/v1/hotels/sync-all"

# List reviews only
curl "http://localhost:8089/api/v1/hotels/123/reviews?limit=20"
```
These endpoints are implemented in `HotelControllerV1`.

Postman collection can be found here  [docs/CupidPostmanCollection](CupidMicroservice.postman_collection.json)

## Swagger UI
The service provides interactive API documentation generated by Swagger. Once the application is running you can browse to
`http://localhost:8089/swagger-ui.html` (or `/swagger-ui/index.html`) to explore and try out the available REST endpoints.

## Metrics
The application exposes a number of Micrometer metrics that can be scraped from `/actuator/prometheus` and visualized in Grafana.

### Counters
- `application.startups` – number of times the service has started
- `review.policy.apply` – invocations of the review filtering policy
- `repository.hotel.findById` – hotel lookup operations
- `repository.hotel.upsert` – new hotel insertions
- `repository.hotel.update` – hotel update operations
- `hotel.i18n.upsert` – insertions of localized hotel records
- `hotel.i18n.update` – updates to localized hotel records
- `domain.events.published` – domain events published to the application context
- `hotel.view.build` – hotel view constructions
- `reviews.cache.hit` / `reviews.cache.miss` – cache hits or misses when fetching reviews
- `reviews.repo.calls` – calls to the review repository
- `cache.hotelView.hit` / `cache.hotelView.miss` – cache hits or misses for hotel views in Redis
- `cache.reviews.hit` / `cache.reviews.miss` – cache hits or misses for review lists in Redis
- `cupid.client.getHotel.calls` – Cupid `getHotel` calls executed
- `cupid.client.getHotelLocalized.calls` – Cupid `getHotelLocalized` calls executed
- `cupid.client.getReviews.calls` – Cupid `getReviews` calls executed

### Timers
- `cupid.client.getHotel`, `cupid.client.getHotelLocalized`, `cupid.client.getReviews` – duration of calls to the external Cupid service
- `controller.hotel.view`, `controller.hotel.sync`, `controller.hotel.reviews.sync`, `controller.hotel.sync.all`, `controller.hotel.reviews`, `controller.hotel.reviews.stats` – request handling times for REST endpoints

## Monitoring with Grafana
Kubernetes manifests provision Grafana with Prometheus and Loki datasources. Apply them and forward the service port:

```bash
kubectl apply -f infra/k8s
kubectl port-forward svc/grafana 3000:3000
```

Grafana will be reachable at <http://localhost:3000>. Default datasources include Prometheus for metrics and Loki for logs.

Login with the default credentials `admin`/`admin` unless configured otherwise.

---

You now have a running Cupid Sync instance, can interact with its APIs and explore metrics and logs through Grafana.

